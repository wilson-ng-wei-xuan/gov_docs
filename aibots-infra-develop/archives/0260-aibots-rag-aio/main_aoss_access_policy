# you might need to add in the access to main_fargate.tf
# module "project" {
#   task_role_inline_policy
# }

resource "aws_opensearchserverless_access_policy" "project" {
  for_each  = { for entry in var.process: "${entry.name}" => entry }

  name        = "${local.opensearch_data_access_name}-${each.value.name}"
  type        = "data"
  description = "read and write permissions"
  policy = jsonencode([
    {
      Rules = [
        {
          ResourceType = "index",
          Resource = [
            "index/${local.AIBOTS_RAG_OPENSEARCH__NAME}*/*"
          ],
          Permission = [
            "aoss:*"
          ]
        },
        {
          ResourceType = "collection",
          Resource = [
            "collection/${local.AIBOTS_RAG_OPENSEARCH__NAME}*"
          ],
          Permission = [
            "aoss:*"
          ]
        }
      ],
      Principal = [
        module.lambda["${each.value.name}"].iam_role.arn
      ]
    }
  ])
}