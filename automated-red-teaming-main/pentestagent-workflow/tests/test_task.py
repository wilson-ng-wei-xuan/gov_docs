import json
import pytest
from schema.task import Task, TaskStatus, WorkflowStage
from uuid import UUID


class TestTaskModel:
    def test_task_creation_defaults(self):
        task = Task(
            name="run_test",
            status=TaskStatus.PENDING,
            stage=WorkflowStage.RECON,
        )

        # UUID should be generated as a string and valid UUID
        assert isinstance(task.uuid, str)
        UUID(task.uuid)  # will raise ValueError if not valid UUID

        assert task.status == TaskStatus.PENDING
        assert task.stage == WorkflowStage.RECON
        assert task.args == []
        assert task.kwargs == {}
        assert task.retry_counter == 0
        assert task.result is None
        assert task.prompt is None

    def test_task_serialization_to_json(self):
        task = Task(
            name="serialize_test",
            status=TaskStatus.IN_PROGRESS,
            stage=WorkflowStage.EXPLOIT,
            args=["http://example.com"],
            kwargs={"headers": {"User-Agent": "Test"}},
            result={"data": 123}
        )
        json_str = task.model_dump_json()
        assert isinstance(json_str, str)
        json_data = json.loads(json_str)  # Parse back to dict

        assert json_data["name"] == "serialize_test"
        assert json_data["status"] == "in_progress"
        assert json_data["stage"] == "exploit"
        assert json_data["args"] == ["http://example.com"]
        assert json_data["kwargs"]["headers"]["User-Agent"] == "Test"
        assert json_data["result"]["data"] == 123

    def test_task_invalid_status_raises(self):
        with pytest.raises(ValueError):
            Task(
                name="bad_status",
                status="not_a_valid_status",  # Invalid
                stage=WorkflowStage.REPORT,
            )

    def test_task_invalid_stage_raises(self):
        with pytest.raises(ValueError):
            Task(
                name="bad_stage",
                status=TaskStatus.COMPLETED,
                stage="not_a_stage",  # Invalid
            )
