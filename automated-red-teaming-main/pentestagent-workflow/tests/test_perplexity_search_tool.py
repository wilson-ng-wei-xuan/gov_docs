import pytest
from tools.perplexity_search import PerplexitySearch
import re
import json

perplexity_search_tool = PerplexitySearch()

@pytest.mark.parametrize("query", [
    "What are the CVEs in Ruby on Rails?",
    "What are the CVEs in PHPMailer?",
    "What are the CVEs in Django?",
])
def test_perplexity_search_parametrized(query):
    # test only synchronous search
    results = perplexity_search_tool.search(query)
    print(results)
    assert not re.search(r"\berror\b", results.lower())
    assert not re.search(r"\b429\b", results)
    assert len(json.loads(results).get("answer", "")) > 0
    assert len(json.loads(results).get("search_results", [])) > 0



