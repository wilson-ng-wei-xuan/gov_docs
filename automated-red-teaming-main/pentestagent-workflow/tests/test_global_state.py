import pytest
from schema.state import GlobalState
from schema.task import Task, TaskStatus, WorkflowStage

class TestGlobalState:
    """
    Test class for GlobalState.
    """
    def make_dummy_task(self, name="run_recon_agent", status=TaskStatus.PENDING, stage=WorkflowStage.RECON):
        return Task(
            name=name,
            args=[["example.com", "example.com/contact"],],
            kwargs={},
            result=None,
            status=status,
            stage=stage,
            prompt="Sample prompt"
        )

    def setup_method(self):
        self.state = GlobalState(goal="Test goal", target="example.com", session_id="test-session-id")

    def test_add_task(self):
        task = self.make_dummy_task()
        self.state.add_task(task)

        assert task.uuid in self.state.task_list
        assert task.name in self.state.task_name_index
        assert task.uuid in self.state.task_name_index[task.name]

    def test_update_task_success(self):
        task = self.make_dummy_task()
        self.state.add_task(task)

        self.state.update_task(uuid=task.uuid, status=TaskStatus.COMPLETED, result="success")

        updated = self.state.task_list[task.uuid]
        assert updated.status == TaskStatus.COMPLETED
        assert updated.result == "success"

    def test_update_task_missing_uuid(self):
        with pytest.raises(ValueError, match="Task with UUID .* not found"):
            self.state.update_task(uuid="nonexistent", status=TaskStatus.COMPLETED)

    def test_update_task_invalid_field(self):
        task = self.make_dummy_task()
        self.state.add_task(task)

        with pytest.raises(ValueError, match="Task has no field named"):
            self.state.update_task(uuid=task.uuid, invalid_field="oops")

    def test_get_tasks_by_name(self):
        task1 = self.make_dummy_task(name="run_recon_agent")
        task2 = self.make_dummy_task(name="run_recon_agent")
        self.state.add_task(task1)
        self.state.add_task(task2)

        result = self.state.get_tasks_by_name("run_recon_agent")

        assert len(result) == 2
        assert all(t.name == "run_recon_agent" for t in result)
