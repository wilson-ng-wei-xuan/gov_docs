import os
import json
from unittest.mock import patch, MagicMock
from custom_agents.base import CustomAgent
from schema.state import GlobalState
from schema.task import Task, TaskStatus, WorkflowStage

class TestCustomAgent:

    @patch("custom_agents.base.get_current_global_state")
    @patch("custom_agents.base.UserInput")
    @patch("custom_agents.base.LiteLLMOpenAIWithRetry")
    def test_initialization(self, mock_llm, mock_user_input, mock_state):
        os.environ["MODEL_ID"] = "test-model-id"
        os.environ["LITELLM_API_KEY"] = "test-api-key"

        mock_tool_instance = MagicMock()
        mock_user_input.return_value = mock_tool_instance
        mock_state.return_value = GlobalState(goal="test-goal", target="test-target",
                                              session_id="test-session-id")

        agent = CustomAgent(
            name="recon_agent",
            goal="Test goal",
            success_criteria="Test success",
            instructions="Test instructions",
            sess_id="test-session",
        )

        # Assert model initialized correctly
        mock_llm.assert_called_once_with(
            id="test-model-id",
            base_url="https://litellm-stg.aip.gov.sg/v1",
            api_key="test-api-key",
            temperature=0
        )

        # Assert tool appended
        assert mock_tool_instance in agent.tools

        # Assert context keys exist
        assert "user_input_tool_info" in agent.context

        # Assert agent name mapping
        assert agent.AGENT_TO_TASK_NAME_MAPPER["recon_agent"] == "run_recon_agent"

    @patch("custom_agents.base.get_current_global_state")
    def test_get_current_global_state_str(self, mock_get_state):
        mock_get_state.return_value = GlobalState(
            goal="test goal",
            target="http://test.com",
            session_id="test-session-id",
            task_list={},
        )

        agent = CustomAgent(
            name="recon_agent",
            goal="Test goal",
            success_criteria="Test success",
            instructions="Test instructions",
            sess_id="test-session",
        )

        state_str = agent._get_current_global_state_str()
        assert isinstance(state_str, str)
        state_dict = json.loads(state_str)
        assert state_dict.get("goal") == "test goal"
        assert state_dict.get("target") == "http://test.com"
        assert state_dict.get("session_id") == "test-session-id"

    @patch("custom_agents.base.get_current_global_state")
    def test_get_previous_task_history(self, mock_get_state):
        task = Task(
            name="run_recon_agent",
            status=TaskStatus.COMPLETED,
            stage=WorkflowStage.RECON,
        )

        mock_state = GlobalState(
            goal="test",
            target="http://target.com",
            session_id="test-session-id",
            task_list={task.uuid: task},
            task_name_index={"run_recon_agent": [task.uuid]},
        )
        mock_get_state.return_value = mock_state

        agent = CustomAgent(
            name="recon_agent",
            goal="Test goal",
            success_criteria="Test success",
            instructions="Test instructions",
            sess_id="test-session",
        )

        json_str = agent._get_previous_task_history()
        assert isinstance(json_str, str)
        json_data = json.loads(json_str)
        assert json_data["tasks"][0]["name"] == "run_recon_agent"
        assert json_data["tasks"][0]["status"] == "completed"
        assert json_data["tasks"][0]["stage"] == "recon"
