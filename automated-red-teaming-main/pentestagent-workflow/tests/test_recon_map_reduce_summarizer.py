from custom_agents.recon.web_page_map_reduce import WebPageAnalyzer
from agno.utils.log import logger
import asyncio
import json
import os
from dataclasses import asdict
import requests

async def test_webpage(input_url: str, output_file: str):
    """Main function to run the web page analysis."""
    analyzer = WebPageAnalyzer(chunk_size=8000, overlap=500, model="azure/gpt-4o")

    try:
        response = requests.get(input_url, timeout=30)
        response.raise_for_status()
        content = response.text
        logger.info(f"Downloaded content from {input_url}")
    except requests.RequestException as e:
        logger.error(f"Error downloading {input_url}: {e}")
        return
    
    analysis_data = await analyzer.process_content(content)
    logger.info(f"Analysis complete for {input_url}")
    with open(output_file, 'w') as f:
        json.dump(asdict(analysis_data), f)

    logger.info("Web page analysis complete! Check the output directory for outputs.")

async def main():    
    await test_webpage("https://www.nlb.gov.sg/main/home", "/tmp/nlb_homepage_analysis.json")
    await test_webpage("https://www.wix.com/", "/tmp/wix_homepage_analysis.json")

if __name__ == "__main__":
    asyncio.run(main())