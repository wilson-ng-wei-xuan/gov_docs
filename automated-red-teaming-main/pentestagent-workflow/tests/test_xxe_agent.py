import unittest
from unittest.mock import patch, MagicMock
from custom_agents.xxe.xxe_agent import run_xxe_agent, FinalTestingResult, ParamResultList
from schema.task import VulnType


class TestRunXXEAgent(unittest.TestCase):
    @patch('custom_agents.xxe.xxe_agent.XXEAgent')
    @patch('custom_agents.xxe.xxe_agent.ResponseFormatterAgent')
    def test_run_open_redirect_agent_success(self, MockResponseFormatterAgent, MockXXEAgent):
        # Setup
        session_id = "test-session"
        url = "http://example.com/vulnerable"
        vuln_param = "version"

        # Prepare tag_recon_info mock input
        tag_recon_info = MagicMock()
        tag_recon_info.tag = VulnType.XXE
        tag_recon_info.url = url
        tag_recon_info.method = "POST"
        tag_recon_info.enctype = "application/xml"
        tag_recon_info.vuln_param = vuln_param
        tag_recon_info.reason = "reason"

        # Mock XXEAgent instance and its run() method
        mock_xxe_agent_instance = MagicMock()
        mock_xxe_agent_instance.run.return_value = MagicMock(content="mocked agent response")
        MockXXEAgent.return_value = mock_xxe_agent_instance

        # Mock ResponseFormatterAgent instance and its run() method
        mock_response_formatter_instance = MagicMock()
        # Return a mocked response with content set to a ParamResultList instance
        mock_param_result_list = MagicMock(spec=ParamResultList)
        mock_response_formatter_instance.run.return_value = MagicMock(content=mock_param_result_list)
        MockResponseFormatterAgent.return_value = mock_response_formatter_instance

        # Call the function under test
        result = run_xxe_agent(tag_recon_info, session_id)

        # Assertions
        self.assertIsInstance(result, FinalTestingResult)
        self.assertIn(vuln_param, result.final_param_result_list)
        self.assertTrue(len(result.final_param_result_list[vuln_param]) > 0)
        self.assertEqual(MockXXEAgent.call_count, 1)
        self.assertEqual(MockResponseFormatterAgent.call_count, 1)

        # Verify that XXEAgent was instantiated with correct args
        MockXXEAgent.assert_called_with(session_id=session_id, show_tool_calls=True)

        # Verify prompt contains the vulnerable URL
        called_prompt = mock_xxe_agent_instance.run.call_args[0][0]
        self.assertIn(url, called_prompt)
        self.assertIn("XXE vulnerabilities", called_prompt)
