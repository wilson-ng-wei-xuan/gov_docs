import pytest
from textwrap import dedent
from agno.agent import Agent
from agno.models.litellm import LiteLLMOpenAI
import os
from dotenv import load_dotenv, find_dotenv
from tools.perplexity_search import PerplexitySearch
from dotenv import find_dotenv, load_dotenv
load_dotenv(find_dotenv())
import re


@pytest.mark.parametrize("query", [
    "Find the CVEs for Python 3.10",
    "What are the latest vulnerabilities in Django?",
    "Search for recent security vulnerabilities in Ruby on Rails",
])
def test_perplexity_search_parametrized(query):
    results = perplexity_agent_search(query)
    print(results)
    assert not re.search(r"\berror\b", results.lower())
    assert not re.search(r"\b429\b", results)
    assert(len(results) > 100)



def perplexity_agent_search(query:str):
    perplexity_search = PerplexitySearch(cache_results=True)
    searcher = Agent(
        name="Search Agent",
        model=LiteLLMOpenAI(
            id=os.getenv("MODEL_ID"),  # Model ID to use
            base_url=os.getenv("OPENAI_API_BASE", "https://litellm-stg.aip.gov.sg"),
            api_key=os.getenv("OPENAI_API_KEY")
        ),
        tools=[
            perplexity_search,
        ],
        show_tool_calls=True,
        markdown=True,
        add_name_to_instructions=True,
        instructions=dedent("""
            You are "Searcher", an AI agent specialized in conducting advanced internet reconnaissance using search engines.

            Your mission is to assist other agents by executing web searches, and internet reconnaissance tasks. You must retrieve accurate and relevant results from publicly available sources, while navigating search engine restrictions, rate limits, and bot protections gracefully.

            Provide clean, well-structured, and relevant search results—including via Google Dorking—to assist other agents with reconnaissance, vulnerability discovery, or research. Act as their eyes on the internet, working silently and smartly behind the scenes.
        """),
        )
    
    return searcher.run(query, stream=False, show_full_reasoning=False, stream_intermediate_steps=False).messages[-1].content




# if __name__ == "__main__":
#     perplexity_agent_search("What are the CVEs in Ruby on Rails?")

