from agno.tools import Toolkit
import contextvars
import asyncio
from typing import Dict
import uuid
from server.sink import StreamEvent, StreamType
# from server.sink import StreamEvent, StreamType
from agno.utils.log import logger
from config.context import current_actions, current_sink

TIMEOUT:int= 30

async def create_user_interaction(message):
    action_id = str(uuid.uuid4())
    
    sink = current_sink.get()
    actions = current_actions.get()
    future = asyncio.Future()
    actions[action_id] = future
    await sink.send(
        StreamEvent(
            type=StreamType.USERINPUT, 
            data=f'[SYSTEM] {message}',
            metadata={'action_id': action_id, 'TTL': TIMEOUT}
        )
    )
    return action_id

async def get_user_input(message_to_user:str, is_binary_choice: bool = False)->str:
    """
    Use this function to get get input from the user. The tool pauses execution flow and requests a response from the user before returning their response.

    Args:
        message_to_user (str): The message to be displayed to the user.
        is_binary_choice (bool): Whether the response is supposed to be a yes/no, y/n or whether it should be free form

    Returns:
        str: The user's response if available, if not a timeout error.
    """
    
    actions = current_actions.get()

    for _ in range(3):
        # Should loop until a valid input is received
        action_id = await create_user_interaction(message_to_user)
        logger.debug(f'Seeking user input with action id {action_id}')
        try:
            user_input = await asyncio.wait_for(actions[action_id], timeout=TIMEOUT)
            logger.debug(f'User input for {action_id} received: {user_input}')
            if is_binary_choice:
                # In the case where it's binary, add constraint that it is a y/n
                normalized_input = user_input.strip().lower()
                if normalized_input in ("y", "yes", "n", "no"):
                    return normalized_input[0] # return "y" or "n"
                else:
                    message_to_user = "Invalid input. Please enter Y or N:"  # re-ask
                    continue

            return user_input 
        except asyncio.CancelledError:
            return f'No user input received after {TIMEOUT} seconds, timing out'