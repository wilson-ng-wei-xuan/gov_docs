import logging
from config.globals import DEBUG_MODE


class ColorFormatter(logging.Formatter):
    """FastAPI-style colored log formatter."""

    COLORS = {
        "DEBUG": "\033[36m",  # Cyan
        "INFO": "\033[92m",  # Bright Green (like FastAPI)
        "WARNING": "\033[93m",  # Bright Yellow
        "ERROR": "\033[91m",  # Bright Red
        "CRITICAL": "\033[95m",  # Bright Magenta
        "RESET": "\033[0m",  # Reset
    }

    def format(self, record):
        levelname = record.levelname
        logger_name = record.name

        # FastAPI-style format: INFO:     module.name:     message
        colored_level = (
            f"{self.COLORS.get(levelname, '')}{levelname}:{self.COLORS['RESET']}"
        )

        # Format similar to FastAPI with proper spacing
        formatted_message = (
            f"{colored_level:<18} {logger_name}:     {record.getMessage()}"
        )

        return formatted_message


class NoDebugFilter(logging.Filter):
    """Filter to suppress DEBUG level messages."""

    def filter(self, record):
        return record.levelno >= logging.INFO


def setup_logging():
    """Configure logging for the entire application."""

    # Configure root logger with default ERROR level for all modules
    root_logger = logging.getLogger()
    root_logger.setLevel(logging.ERROR)

    # Remove any existing handlers to avoid duplicates
    for handler in root_logger.handlers[:]:
        root_logger.removeHandler(handler)

    handler = logging.StreamHandler()
    handler.setFormatter(ColorFormatter())
    root_logger.addHandler(handler)

    # Set INFO level specifically for application modules
    for module in ["server", "db", "sink", "__main__"]:
        custom_logger = logging.getLogger(module)
        custom_logger.setLevel(logging.INFO)
 
    # Suppress Agno logger forcefully using filter if needed
    # agno.utils.log functions don't work properly
    if not DEBUG_MODE:
        try:
            from agno.utils.log import logger as agno_logger

            agno_logger.setLevel(logging.INFO)
            agno_logger.addFilter(NoDebugFilter())
        except ImportError:
            # Handle case where agno is not available
            pass

