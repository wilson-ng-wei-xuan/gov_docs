import time
import json
from dataclasses import dataclass, asdict, field
from enum import Enum
from typing import Any, Protocol, Optional, Dict, Union


class StreamType(Enum):
    
    # WORKFLOW TYPES    
    RUN_COMPLETE="RunComplete"
    
    # MODULE TYPES (e.g. run_x_agent)
    INITIATE = "Initiate"
    COMPLETE = "Complete"
    CANCEL = "Cancel"
    ERROR = "Error"

    # DIAGNOSTIC TYPES
    DIAGNOSTICSTART = "DiagnosticStart"
    DIAGNOSTICCOMPLETE = "DiagnosticComplete"

    # AGENT TYPES
    AGENT_START="AgentStart"
    AGENT_END="AgentEnd"
    
    # STREAMING MESSAGE TYPES
    SYSTEM="system"
    USER="user"
    RUN_RESPONSE_CONTENT = "RunResponseContent"
    TOOLSTART = "ToolCallStarted"
    TOOLCOMPLETE = "ToolCallCompleted"
    USERINPUT = "UserInput"


@dataclass
class StreamEvent:
    type: StreamType
    data: Union[str, Dict[str, Any]]
    metadata: Dict[str, Any] = field(default_factory=dict)
    ts: float = field(default_factory=time.time)

    def to_json(self) -> str:
        return json.dumps(
            asdict(self),
            ensure_ascii=False,
            default=lambda o: o.value if isinstance(o, Enum) else str(o),
        )


class StreamSink(Protocol):
    """Base protocol for Sink classes."""

    async def send(self, event: StreamEvent) -> None: ...
    async def close(self) -> None: ...
    async def get(self) -> Optional[StreamEvent]: ...

class NullSink:
    """Placeholder sink that does nothing."""

    async def send(self, event: StreamEvent) -> None:
        return

    async def close(self) -> None:
        return