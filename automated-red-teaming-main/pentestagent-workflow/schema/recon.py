from pydantic import BaseModel, Field, ConfigDict
from typing import Optional, Dict, List
from schema.task import VulnType

# Dorking Assessment Info:
class ExploitCVEInfo(BaseModel):
    id: str
    summary: str
    link: str

class PassiveEvidence(BaseModel):
    vulnerability: Optional[str] = None
    cves_exploits: List[ExploitCVEInfo] = Field(default_factory=list)

class PassiveLinkInfo(BaseModel):
    url: str
    passive_evidence: Optional[PassiveEvidence] = None

class PassiveReconOutput(BaseModel):
    dorking_links: List[PassiveLinkInfo] = Field(default_factory=list)


# Katana Output Model
class KatanaEndpointMethod(BaseModel):
    method: str
    enctype: Optional[str] = None
    parameters: Optional[List[Dict]] = Field(default_factory=list)
    parameter_sets: Optional[List[str]] = Field(default_factory=list)


class KatanaEndpoint(BaseModel):
    url: str
    technologies: Optional[List[str]] = None
    methods: List[KatanaEndpointMethod] = Field(default_factory=list)
    passive_evidence: Optional[PassiveEvidence] = None

class KatanaAnalysisOutput(BaseModel):
    endpoints: List[KatanaEndpoint]

# Fingerprint Output Model
class FingerprintInfo(BaseModel):
    url: str
    method: str
    enctype: Optional[str] = None
    unique_parameters: Optional[List[str]]

class FingerprintInfoList(BaseModel):
    endpoints: List[FingerprintInfo]

class FingerprintOutput(BaseModel):
   technologies: Optional[List[str]] = None

# Recon Agent Output
class TagReconInfo(BaseModel):
    tag: VulnType
    url: str
    method: Optional[str] = None
    enctype: Optional[str] = None
    vuln_param: Optional[str] = None
    param_set: Optional[str] = None
    reason: Optional[str] = None

class VulnParamSet(BaseModel):
    vuln_param: Optional[str] = Field(
        default=None,
        description="The name of the vulnerable parameter."
    )
    param_set: Optional[str] = Field(
        default=None,
        description="The parameter set associated with the vulnerability."
    )
    tags: List[VulnType] = Field(
        default_factory=list,
        description="List of vulnerability types detected for this parameter and parameter set."
    )
    reason: Optional[str] = Field(
        default=None,
        description="Explanation or evidence for why this parameter and parameter set is considered vulnerable."
    )
    method: Optional[str] = Field(
        default=None,
        description="HTTP method used (e.g., GET, POST) for the request."
    )
    enctype: Optional[str] = Field(
        default=None,
        description="Content type of the request (e.g., application/x-www-form-urlencoded)."
    )

class VulParamSetList(BaseModel):
    vuln_param_sets: List[VulnParamSet] = Field(
        default_factory=list,
        description="List of vulnerable parameter sets detected."
    )
    
class ReconEndpointOutput(BaseModel):
    url: str
    vuln_param_sets: List[VulnParamSet] = Field(default_factory=list)
    technologies: Optional[List[str]] = None

    def get_tag_recon_outputs(self) -> List[TagReconInfo]:
        return [
            TagReconInfo(
                tag=tag,
                url=self.url,
                method=vps.method,
                enctype=vps.enctype,
                vuln_param=vps.vuln_param,
                param_set=vps.param_set,
                reason=vps.reason
            )
            for vps in self.vuln_param_sets
            for tag in vps.tags
        ]

class ReconOutput(BaseModel):
    model_config = ConfigDict(use_enum_values=True)
    assessments: List[ReconEndpointOutput] = Field(default_factory=list)
