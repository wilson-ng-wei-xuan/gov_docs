import re
import os
import copy
from tools.guardrails.common import precheck_for, xxe_rce_check, xxe_dos_check, xxe_cookie_check, SafetyResult
from tools.web_requester.guardrails.common import WebRequesterGuardrail, combine_payload
from typing import Any, Optional, Dict

MAX_SQLI_DELAY = int(os.getenv("MAX_SQLI_DELAY", 90))

# Pre-checks
@precheck_for("run_web_requester", "arun_web_requester")
async def xxe_rce_web_check(
            url: str,
            method: str = "GET",
            headers: Optional[Dict[str, str]] = None,
            data: Any = None
        ) -> SafetyResult:
    """
    Checks XXE payloads for destructive elements that could result in RCE on the system

    Args:
        url (str): Target URL.
        method (str): HTTP method (GET, POST, etc.).
        headers (dict): HTTP headers.
        data (Any): Request payload (str, bytes, dict, list, or None).

    Returns:
        Optional[str]: 'Unsafe: ...' if such destructive elements are found
    """
    payload = combine_payload(url, data)

    return xxe_rce_check(payload=payload)

@precheck_for("run_web_requester", "arun_web_requester")
async def xxe_requester_dos_check(url: str,
            method: str = "GET",
            headers: Optional[Dict[str, str]] = None,
            data: Any = None
        ) -> SafetyResult:
    """
    Checks XXE payloads for patterns such as recursive ones that could potentially cause a DoS for the target

    Args:
        url (str): Target URL.
        method (str): HTTP method.
        headers (dict): HTTP headers.
        data (Any): Request payload.

    Returns:
        Optional[str]: 'Unsafe: ...' if payload has elements that could result in a DoS
    """
    payload = combine_payload(url, data)
    
    return xxe_dos_check(payload=payload)

@precheck_for("run_web_requester", "arun_web_requester")
async def xxe_cookie_manipulation_usage_check(url: str,
                method: str = "GET",
                headers: Optional[Dict[str, str]] = None,
                data: Any = None
            ) -> SafetyResult:
    """
    Checks XXE payloads for operations that may tamper, leak or modify cookies. This includes checking headers

    Args:
        url (str): Target URL.
        method (str): HTTP method.
        headers (dict): HTTP headers.
        data (Any): Request payload.

    Returns:
        Optional[str]: 'Unsafe: ...' if payload does the above action
    """
    payload = combine_payload(url, data)
    
    temp = xxe_cookie_check(payload=payload)
    if temp is not None:
        return temp
    
    if not headers:
        return None
    
    for name, line in headers.items():
        temp = xxe_cookie_check(f"{name}:{line}")
        if temp is not None:
            return temp
        
    return None

# Post-processing

# Guardrail

class XXEWebRequesterGuardRail(WebRequesterGuardrail):
    """
    GuardRail for XXE Web Requests. Applies pre-checks to validate XXE payloads
    before sending them to the WebRequester. Post-processing steps can also be configured.

    Args:
        pre_flags (set[str] | str, optional):
            Which pre-check functions to enable. Options are:
            - "all" (default): enable all pre-check functions.
            - "none": disable all pre-check functions.
            - set of strings: choose specific checks, e.g. {"rce_check", "dos"}.

            Available pre-checks:
                - "rce_check": Checks for harmful elements that may indicate attempts at RCE
                - "dos": Blocks payloads that may result in DoS for the target
                - "cookie_use": Checks for manipulation/usage/tampering of cookies

        post_flags (set[str] | str, optional):
            Which post-processing functions to enable. Options are:
            - "all" (default): enable all post-processing functions.
            - "none": disable all post-processing functions.
            - set of strings: choose specific steps (currently none are defined).

            Available post-processors: None
    """

    def __init__(
        self,
        pre_flags: set[str] | str = "all",
        post_flags: set[str] | str = "all",
    ):
        # Map string names to functions
        VALID_PRE = {
            "rce_check": xxe_rce_web_check,
            "dos": xxe_requester_dos_check,
            "cookie_use": xxe_cookie_manipulation_usage_check,
        }

        VALID_POST = {
        }

        # Normalize flags
        if isinstance(pre_flags, str):
            pre_funcs = set() if pre_flags.lower() == "none" else set(VALID_PRE.keys())
        else:
            pre_funcs = copy.deepcopy(pre_flags)
            
        if isinstance(post_flags, str):
            post_funcs = set() if post_flags.lower() == "none" else set(VALID_POST.keys())
        else:
            post_funcs = copy.deepcopy(post_flags)

        pre_check = [func for name, func in VALID_PRE.items() if name in pre_funcs]
        post_process = [func for name, func in VALID_POST.items() if name in post_funcs]

        super().__init__(pre_flags=pre_flags, post_flags=post_flags, pre_check=pre_check, post_process=post_process, name="xxe_web")


