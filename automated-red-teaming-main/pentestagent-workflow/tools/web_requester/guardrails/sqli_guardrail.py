import re
import os
import copy
from tools.guardrails.common import precheck_for, sqli_mod_check, sqli_interaction_check, sqli_dos, SafetyResult
from tools.web_requester.guardrails.common import WebRequesterGuardrail, combine_payload
from typing import Any, Optional, Dict

# Pre-checks
@precheck_for("run_web_requester", "arun_web_requester")
async def sql_requester_table_modification(
            url: str,
            method: str = "GET",
            headers: Optional[Dict[str, str]] = None,
            data: Any = None
        ) -> SafetyResult:
    """
    Checks SQL payloads for destructive schema changes like DROP, TRUNCATE, ALTER, CREATE, or RENAME of tables/databases.

    Args:
        url (str): Target URL.
        method (str): HTTP method (GET, POST, etc.).
        headers (dict): HTTP headers.
        data (Any): Request payload (str, bytes, dict, list, or None).

    Returns:
        Optional[str]: 'Unsafe: ...' if destructive schema operations are detected, otherwise None.
    """
    payload = combine_payload(url, data)

    return sqli_mod_check(payload=payload)

@precheck_for("run_web_requester", "arun_web_requester")
async def sql_requester_file_os_interaction(url: str,
            method: str = "GET",
            headers: Optional[Dict[str, str]] = None,
            data: Any = None
        ) -> SafetyResult:
    """
    Checks SQL payloads for file system or OS interaction attempts, including LOAD_FILE, INTO OUTFILE, xp_cmdshell, or server-specific system calls.

    Args:
        url (str): Target URL.
        method (str): HTTP method.
        headers (dict): HTTP headers.
        data (Any): Request payload.

    Returns:
        Optional[str]: 'Unsafe: ...' if payload attempts file/OS interaction, otherwise None.
    """
    payload = combine_payload(url, data)
    
    return sqli_interaction_check(payload=payload)

@precheck_for("run_web_requester", "arun_web_requester")
async def sql_requester_dos(url: str,
                method: str = "GET",
                headers: Optional[Dict[str, str]] = None,
                data: Any = None
            ) -> SafetyResult:
    """
    Checks SQL payloads for operations that may cause denial-of-service, such as long SLEEP/WAITFOR delays or recursive CTEs.

    Args:
        url (str): Target URL.
        method (str): HTTP method.
        headers (dict): HTTP headers.
        data (Any): Request payload.

    Returns:
        Optional[str]: 'Unsafe: ...' if payload may cause DoS, otherwise None.
    """
    payload = combine_payload(url, data)
    
    return sqli_dos(payload=payload)

# Post-processing

# Guardrail

class SQLWebRequesterGuardRail(WebRequesterGuardrail):
    """
    GuardRail for SQL Web Requests. Applies pre-checks to validate SQL payloads
    before sending them to the WebRequester. Post-processing steps can also be configured.

    Args:
        pre_flags (set[str] | str, optional):
            Which pre-check functions to enable. Options are:
            - "all" (default): enable all pre-check functions.
            - "none": disable all pre-check functions.
            - set of strings: choose specific checks, e.g. {"file_modification", "dos"}.

            Available pre-checks:
                - "file_modification": blocks destructive schema changes (DROP, ALTER, etc.)
                - "fs_os_interaction": blocks LOAD_FILE, INTO OUTFILE, xp_cmdshell, etc.
                - "dos": blocks long SLEEP/WAITFOR and recursive CTEs

        post_flags (set[str] | str, optional):
            Which post-processing functions to enable. Options are:
            - "all" (default): enable all post-processing functions.
            - "none": disable all post-processing functions.
            - set of strings: choose specific steps (currently none are defined).

            Available post-processors: None
    """

    def __init__(
        self,
        pre_flags: set[str] | str = "all",
        post_flags: set[str] | str = "all",
    ):
        # Map string names to functions
        VALID_PRE = {
            "file_modification": sql_requester_table_modification,
            "fs_os_interaction": sql_requester_file_os_interaction,
            "dos": sql_requester_dos,
        }

        VALID_POST = {
        }

        # Normalize flags
        if isinstance(pre_flags, str):
            pre_funcs = set() if pre_flags.lower() == "none" else set(VALID_PRE.keys())
        else:
            pre_funcs = copy.deepcopy(pre_flags)
            
        if isinstance(post_flags, str):
            post_funcs = set() if post_flags.lower() == "none" else set(VALID_POST.keys())
        else:
            post_funcs = copy.deepcopy(post_flags)

        pre_check = [func for name, func in VALID_PRE.items() if name in pre_funcs]
        post_process = [func for name, func in VALID_POST.items() if name in post_funcs]

        super().__init__(pre_flags=pre_flags, post_flags=post_flags, pre_check=pre_check, post_process=post_process, name="sqli_web")


