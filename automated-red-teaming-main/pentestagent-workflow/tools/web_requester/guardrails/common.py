import os, copy
from urllib.parse import urlparse, parse_qs, unquote
from tools.guardrails.base import Guardrail
from tools.guardrails.common import precheck_for, truncate_output, redact_sensitive_info, SafetyResult
from typing import Callable, List, Any, Optional, Dict

# Common Helper functions and constants
MAX_WEB_REQUESTER_TIMEOUT = int(os.getenv("MAX_WEB_REQUESTER_TIMEOUT", 120))
MAX_WEB_REQUESTER_INPUT = int(os.getenv("MAX_WEB_REQUESTER_INPUT", 2000))

def combine_payload(url: str, data: Any) -> str:
    """
    Combine URL and request data into a single string for inspection.

    - Includes query parameters from the URL
    - Includes POST data (if dict, list, or string)
    - Decodes URL-encoded values
    """
    parts = []

    # Include the URL itself
    parts.append(url)

    # Include query parameters
    parsed_url = urlparse(url)
    qs = parse_qs(parsed_url.query)
    for values in qs.values():
        for v in values:
            parts.append(v)

    # Include POST/body data
    if data is not None:
        if isinstance(data, (dict, list)):
            import json
            parts.append(json.dumps(data))  # serialize to string
        else:
            parts.append(str(data))

    # Combine all parts into a single string
    combined_payload = " ".join(parts)
    return combined_payload

class WebRequesterGuardrail(Guardrail):
    """
    GuardRail for WebRequester. Applies pre-checks to validate general payloads
    before sending them to the WebRequester. Post-processing steps can also be configured.

    Args:
        pre_flags (set[str] | str, optional):
            Which pre-check functions to enable. Options are:
            - "all" (default): enable all pre-check functions.
            - "none": disable all pre-check functions.
            - set of strings: choose specific checks, e.g. {"file_modification", "dos"}.

            Available pre-checks:
                - "input_length": makes sure that the combined size of the request is limited

        post_flags (set[str] | str, optional):
            Which post-processing functions to enable. Options are:
            - "all" (default): enable all post-processing functions.
            - "none": disable all post-processing functions.
            - set of strings: choose specific steps (currently none are defined).

            Available post-processors:
                - "redact_sensitive_info": redacts patterns which might be sensitive like passwords, keys
                - "truncate_output": ensures that the tool output is limited to a certain quantity
    """

    def __init__(
        self,
        pre_flags: set[str] | str = "all",
        post_flags: set[str] | str = "all",
        pre_check: List[Callable] = [],
        post_process: List[Callable] = [],
        max_input_size: int = MAX_WEB_REQUESTER_INPUT,
        name: str = "default_web"
    ):
        pre_check = copy.deepcopy(pre_check)
        post_process = copy.deepcopy(post_process)

        @precheck_for("run_web_requester", "arun_web_requester")
        async def web_requester_input_limit(
            url: str,
            method: str = "GET",
            headers: Optional[Dict[str, str]] = None,
            data: Any = None
        ) -> SafetyResult:
            if len(combine_payload(url=url, data=data)) > max_input_size:
                return "Unsafe: Input size is too large"
            
            return None
        
        # Map string names to functions
        VALID_PRE = {
            "input_length": web_requester_input_limit
        }

        VALID_POST = {
            "redact_sensitive_info": redact_sensitive_info,
            "truncate_output": truncate_output
        }

        # Normalize flags
        if isinstance(pre_flags, str):
            pre_flags = set() if pre_flags.lower() == "none" else set(VALID_PRE.keys())
        if isinstance(post_flags, str):
            post_flags = set() if post_flags.lower() == "none" else set(VALID_POST.keys())
        
        pre_check.extend([func for name, func in VALID_PRE.items() if name in pre_flags])
        post_process.extend([func for name, func in VALID_POST.items() if name in post_flags])

        super().__init__(pre_checking=pre_check, post_processing=post_process, name=name)
