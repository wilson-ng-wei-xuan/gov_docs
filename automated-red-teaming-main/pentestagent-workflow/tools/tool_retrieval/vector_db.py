from typing import Dict, Any
from threading import Lock


class LocalVectorDB:
    """
    Thread-safe singleton class for storing and retrieving tool output chunks.

    This class maintains a mapping from `output_id` to its associated chunks,
    where each chunk is identified by `chunk_id` and contains content and optional metadata.
    """

    _instance = None
    _lock = Lock()

    def __new__(cls):
        """
        Ensure that only one instance of LocalVectorDB exists (singleton pattern).

        Returns:
            LocalVectorDB: The shared singleton instance of the database.
        """
        with cls._lock:
            if cls._instance is None:
                cls._instance = super().__new__(cls)
                cls._instance._store = {}
            return cls._instance

    def upsert_chunk(self, output_id: str, chunk_id: str, content: str, metadata: dict = None) -> None:
        """
        Insert or update a chunk for a given output ID.

        Args:
            output_id (str): The unique identifier of the tool output.
            chunk_id (str): The unique identifier of the chunk within the output.
            content (str): The content of the chunk.
            metadata (dict, optional): Additional metadata associated with the chunk. Defaults to {}.

        Returns:
            None
        """
        if output_id not in self._store:
            self._store[output_id] = {}
        self._store[output_id][chunk_id] = {
            "content": content,
            "metadata": metadata or {}
        }

    def get_chunks(self, output_id: str) -> Dict[str, Dict[str, Any]]:
        """
        Retrieve all chunks for a given output ID.

        Args:
            output_id (str): The unique identifier of the tool output.

        Returns:
            Dict[str, Dict[str, Any]]: A mapping of chunk IDs to their content and metadata.
        """
        return self._store.get(output_id, {})

    def get_chunk(self, output_id: str, chunk_id: str) -> Dict[str, Any]:
        """
        Retrieve a specific chunk by its ID for a given output ID.

        Args:
            output_id (str): The unique identifier of the tool output.
            chunk_id (str): The unique identifier of the chunk within the output.

        Returns:
            Dict[str, Any]: The chunk data containing content and metadata, or None if not found.
        """
        return self._store.get(output_id, {}).get(chunk_id)

    def all_tool_calls(self) -> Dict[str, Dict[str, Dict[str, Any]]]:
        """
        Retrieve the full mapping of all stored tool calls and their chunks.

        Returns:
            Dict[str, Dict[str, Dict[str, Any]]]: The complete store mapping
            output IDs to chunk IDs and their content/metadata.
        """
        return self._store


# Shared singleton instance
vector_db = LocalVectorDB()
